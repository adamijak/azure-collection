version: '3'

silent: true

tasks:
  token:graph: azure-auth cert --raw -t $TENANT_ID -c $CLIENT_ID --cert $CERT_THUMBPRINT --scopes "https://graph.microsoft.com/.default"
  token:sharepoint: azure-auth cert --raw -t $TENANT_ID -c $CLIENT_ID --cert $CERT_THUMBPRINT --scopes="https://greycorbel.sharepoint.com/.default"
  
  "*:*:*":
    vars:
      ARG_0: '{{index .MATCH 0}}'
      ARG_1: '{{index .MATCH 1}}'
      ARG_2: '{{index .MATCH 2}}'
    cmds:
      - task: hurl
        vars:
          FILE: ./{{.ARG_0}}/{{.ARG_1}}/{{.ARG_2}}.hurl
          ENV_FILE: ./env/{{.ARG_0}}.env
          
  hurl:
    internal: true
    cmd: |
      {{if or .BODY .B .body .b}}
        hurl --no-color --variables-file {{.ENV_FILE}} --variable token="$AZURE_TOKEN" {{.FILE}}
      {{else}}
        hurl -i --color --variables-file {{.ENV_FILE}} --variable token="$AZURE_TOKEN" {{.FILE}} | jq -CRr 'fromjson? // .'
      {{end}}
